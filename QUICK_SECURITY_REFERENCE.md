# üîê Quick Security Reference Card

## Generate Token
```bash
python scripts/bootstrap_internal_token.py  # run from repo root
```

## Configure Services

### Clustering Service
File: `sploot_media_clustering/.env.local`
```bash
INTERNAL_SERVICE_TOKEN=<auto-generated-token>
```

### Auth Service
File: `sploot-auth-service/.env.local`
```bash
SPLOOT_MEDIA_CLUSTERING_TOKEN=<same-token>
```

‚ö†Ô∏è **Both must use the SAME token!**

## Start Services
```bash
cd sploot_media_clustering
export INTERNAL_SERVICE_TOKEN=$(grep INTERNAL_SERVICE_TOKEN .env.local | cut -d'=' -f2)
docker compose -f docker-compose.local.yml up -d
```

## Test Security
```bash
# Should succeed (200)
cd sploot-auth-service
export $(cat .env.local | grep SPLOOT_MEDIA_CLUSTERING_TOKEN | xargs)
python scripts/test_clustering_direct.py

# Should fail (401)
python -c "import asyncio, httpx; asyncio.run((lambda: httpx.AsyncClient().get('http://localhost:9007/internal/pets/shamu/clusters', headers={'X-Internal-Token': 'wrong'}))())"
```

## Troubleshooting

| Problem | Solution |
|---------|----------|
| 401 Unauthorized | Tokens don't match - check both `.env.local` files |
| Token not loading | Restart services after updating |
| "changeme" in logs | Environment variable not set |

## Production Checklist
- [ ] Generate unique token (not the dev one!)
- [ ] Store in AWS Secrets Manager / Vault
- [ ] Different tokens for staging/production
- [ ] Set up token rotation schedule (90 days)
- [ ] Enable audit logging
- [ ] Document recovery procedures

## Emergency: Token Compromised
```bash
# 1. Generate and sync a new token immediately
python scripts/bootstrap_internal_token.py

# 2. Update both services
# 3. Deploy auth service first
# 4. Then deploy clustering service
# 5. Monitor for auth errors
# 6. Revoke old token from secrets manager
```

---
üìñ Full docs: [SECURITY.md](SECURITY.md)
