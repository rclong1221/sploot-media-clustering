# Security Setup Guide

## Internal Service Authentication

The media clustering service and auth service communicate using an internal authentication token. This token must be kept secret and should never be committed to version control.

## Quick Start

### 1. Generate a Secure Token

```bash
python scripts/bootstrap_internal_token.py  # run from repo root
```

This generates a cryptographically secure 64-character token and writes it to the local env files for both clustering and auth services.

### 2. Configure Services

The script updates both services automatically, but you can verify or copy the values manually if needed:

**Clustering Service** (`sploot_media_clustering/.env.local`):
```bash
INTERNAL_SERVICE_TOKEN=<auto-generated-token>
```

**Auth Service** (`sploot-auth-service/.env.local`):
```bash
SPLOOT_MEDIA_CLUSTERING_TOKEN=<same-token-as-above>
```

⚠️ **IMPORTANT**: Both services MUST use the same token—which the bootstrap script enforces.

### 3. For Docker Compose

Set the token as an environment variable before starting services:

```bash
cd sploot_media_clustering
export INTERNAL_SERVICE_TOKEN=<your-generated-token>
docker compose -f docker-compose.local.yml up
```

Or create a `.env` file in the docker-compose directory (also add to .gitignore):

```bash
INTERNAL_SERVICE_TOKEN=<your-generated-token>
```

## Security Best Practices

### Token Management

1. ✅ **Generate**: Use the provided script or equivalent secure method
2. ✅ **Store**: Keep in environment variables or secrets management (AWS Secrets Manager, HashiCorp Vault, etc.)
3. ✅ **Protect**: Never commit to version control (`.env.local` is in `.gitignore`)
4. ✅ **Rotate**: Change the token every 90 days or immediately if compromised
5. ✅ **Revoke**: If a token is compromised, generate a new one immediately

### Development vs Production

**Development** (`.env.local`):
- Use a generated token for local testing
- Can be shared among team members via secure channel (1Password, LastPass, etc.)
- Still should NOT be committed to git

**Production** (Secrets Management):
- Use AWS Secrets Manager, Azure Key Vault, or HashiCorp Vault
- Rotate automatically on a schedule
- Audit all access to the token
- Use different tokens for staging/production environments

### Example: AWS Secrets Manager

```python
import boto3
import json

def get_internal_token():
    client = boto3.client('secretsmanager', region_name='us-east-1')
    response = client.get_secret_value(SecretId='sploot/internal-service-token')
    return json.loads(response['SecretString'])['token']
```

### Example: Environment Variables in Production

```bash
# In your deployment script or container orchestration:
export INTERNAL_SERVICE_TOKEN=$(aws secretsmanager get-secret-value \
    --secret-id sploot/internal-service-token \
    --query SecretString --output text | jq -r .token)
```

## Token Rotation Procedure

1. Generate and sync a new token:
  ```bash
  python scripts/bootstrap_internal_token.py  # run from repo root
  ```

2. Update in secrets management system

3. Deploy auth service with new token first (it becomes a client)

4. Verify auth service can still call clustering service (old token still works)

5. Deploy clustering service with new token (it validates the token)

6. Monitor logs for authentication errors

7. Roll back if issues detected

## Verification

Test that the token is working:

```bash
cd sploot-auth-service
python scripts/test_clustering_direct.py
```

Expected output:
```
✅ Got cluster data!
  Pet ID: shamu
  Clusters: 1
  ...
```

If you see authentication errors:
- Check both services have the SAME token
- Verify the token has no extra whitespace
- Confirm the token is properly loaded from environment

## Troubleshooting

### "invalid internal token" error

**Cause**: Token mismatch between services

**Fix**:
1. Check clustering service: `echo $INTERNAL_SERVICE_TOKEN`
2. Check auth service: `echo $SPLOOT_MEDIA_CLUSTERING_TOKEN`
3. Ensure they match exactly
4. Restart both services after updating

### Token not loading

**Cause**: Environment variable not set or wrong name

**Fix**:
1. Clustering service expects: `INTERNAL_SERVICE_TOKEN`
2. Auth service expects: `SPLOOT_MEDIA_CLUSTERING_TOKEN`
3. Check `.env.local` exists and is being loaded
4. Verify no typos in variable names

### Docker Compose issues

**Cause**: Environment variable not passed to containers

**Fix**:
1. Set `INTERNAL_SERVICE_TOKEN` before running docker-compose
2. Or add to docker-compose.override.yml (don't commit!)
3. Check container logs: `docker logs <container-name>`

## References

- [OWASP API Security](https://owasp.org/www-project-api-security/)
- [Token Generation Best Practices](https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html)
- [Python secrets module](https://docs.python.org/3/library/secrets.html)
